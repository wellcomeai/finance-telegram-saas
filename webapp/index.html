<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finance Tracker</title>
    
    <!-- Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Apple Style CSS -->
    <link rel="stylesheet" href="/webapp/css/style.css">
</head>
<body data-theme="light">
    
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section active">
        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount" id="totalBalance">0 ‚ÇΩ</div>
            <div class="balance-stats">
                <div class="stat-item">
                    <div class="stat-label">–î–æ—Ö–æ–¥—ã</div>
                    <div class="stat-value" id="totalIncome">0 ‚ÇΩ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
                    <div class="stat-value" id="totalExpense">0 ‚ÇΩ</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat-card">
                <div class="quick-stat-icon">üìä</div>
                <div class="quick-stat-value" id="transactionCount">0</div>
                <div class="quick-stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
            </div>
            <div class="quick-stat-card">
                <div class="quick-stat-icon">üî•</div>
                <div class="quick-stat-value" id="avgExpense">0 ‚ÇΩ</div>
                <div class="quick-stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥</div>
            </div>
            <div class="quick-stat-card">
                <div class="quick-stat-icon">üìà</div>
                <div class="quick-stat-value" id="topCategory">‚Äî</div>
                <div class="quick-stat-label">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            </div>
        </div>

        <!-- Date Filters -->
        <div class="date-filters">
            <div class="filter-pill active" data-filter="today" onclick="applyDateFilter('today')">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="filter-pill" data-filter="week" onclick="applyDateFilter('week')">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-pill" data-filter="month" onclick="applyDateFilter('month')">–ú–µ—Å—è—Ü</div>
            <div class="filter-pill" data-filter="year" onclick="applyDateFilter('year')">–ì–æ–¥</div>
            <div class="filter-pill" data-filter="all" onclick="applyDateFilter('all')">–í—Å—ë –≤—Ä–µ–º—è</div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-title">üìä –†–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <canvas id="expenseChart"></canvas>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions-section">
            <div class="section-header">
                <h3 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
            </div>
            <div id="recentTransactions">
                <!-- Skeleton Loaders -->
                <div class="skeleton skeleton-transaction">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-content">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-subtitle"></div>
                    </div>
                    <div class="skeleton skeleton-amount"></div>
                </div>
                <div class="skeleton skeleton-transaction">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-content">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-subtitle"></div>
                    </div>
                    <div class="skeleton skeleton-amount"></div>
                </div>
                <div class="skeleton skeleton-transaction">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-content">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-subtitle"></div>
                    </div>
                    <div class="skeleton skeleton-amount"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Section -->
    <div id="transactions" class="section">
        <!-- Date Filters -->
        <div class="date-filters">
            <div class="filter-pill active" data-filter="today" onclick="applyDateFilter('today')">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="filter-pill" data-filter="week" onclick="applyDateFilter('week')">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-pill" data-filter="month" onclick="applyDateFilter('month')">–ú–µ—Å—è—Ü</div>
            <div class="filter-pill" data-filter="year" onclick="applyDateFilter('year')">–ì–æ–¥</div>
            <div class="filter-pill" data-filter="all" onclick="applyDateFilter('all')">–í—Å—ë –≤—Ä–µ–º—è</div>
        </div>

        <div class="transactions-section">
            <div class="section-header">
                <h3 class="section-title">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
            </div>
            <div id="allTransactions">
                <!-- Skeleton Loaders -->
                <div class="skeleton skeleton-transaction">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-content">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-subtitle"></div>
                    </div>
                    <div class="skeleton skeleton-amount"></div>
                </div>
                <div class="skeleton skeleton-transaction">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-content">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-subtitle"></div>
                    </div>
                    <div class="skeleton skeleton-amount"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section -->
    <div id="stats" class="section">
        <!-- Date Filters -->
        <div class="date-filters">
            <div class="filter-pill active" data-filter="today" onclick="applyDateFilter('today')">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="filter-pill" data-filter="week" onclick="applyDateFilter('week')">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-pill" data-filter="month" onclick="applyDateFilter('month')">–ú–µ—Å—è—Ü</div>
            <div class="filter-pill" data-filter="year" onclick="applyDateFilter('year')">–ì–æ–¥</div>
            <div class="filter-pill" data-filter="all" onclick="applyDateFilter('all')">–í—Å—ë –≤—Ä–µ–º—è</div>
        </div>

        <div class="chart-container" style="margin-top: 20px;">
            <div class="chart-title">üìä –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
            <canvas id="categoryChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <canvas id="trendChart"></canvas>
        </div>

        <div class="transactions-section">
            <h3 class="section-title">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
            <div id="topCategories"></div>
        </div>
    </div>

    <!-- Add Button -->
    <div class="add-btn-container">
        <button class="add-btn" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchSection('dashboard')">
            <i class="fas fa-home"></i>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="switchSection('transactions')">
            <i class="fas fa-list"></i>
            <span>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
        </div>
        <div class="nav-item" onclick="switchSection('stats')">
            <i class="fas fa-chart-bar"></i>
            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </div>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-backdrop" onclick="closeModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–ù–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</h2>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="type-toggle">
                    <button class="type-btn expense active" onclick="selectType('expense')">
                        üí∏ –†–∞—Å—Ö–æ–¥
                    </button>
                    <button class="type-btn income" onclick="selectType('income')">
                        üí∞ –î–æ—Ö–æ–¥
                    </button>
                </div>

                <form id="transactionForm" onsubmit="saveTransaction(event)">
                    <input type="hidden" id="transactionId" value="">
                    <input type="hidden" id="transactionType" value="expense">

                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ *</label>
                        <input type="number" id="amount" class="form-input" placeholder="0.00" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <div id="categoryGrid" class="category-grid">
                            <!-- Categories will be dynamically inserted here by app.js -->
                        </div>
                        <input type="hidden" id="categoryId" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="description" class="form-textarea" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞</label>
                        <input type="date" id="transactionDate" class="form-input" required>
                    </div>

                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>

                    <button type="button" id="deleteBtn" class="delete-btn" style="display: none;" onclick="deleteTransaction()">
                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/webapp/js/telegram.js"></script>
    <script src="/webapp/js/api.js"></script>
    <script src="/webapp/js/app.js"></script>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            const icon = document.getElementById('themeIcon');
            
            body.setAttribute('data-theme', newTheme);
            icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Save to localStorage
            localStorage.setItem('theme', newTheme);
            
            // Animate icon
            icon.style.transform = 'rotate(360deg)';
            setTimeout(() => {
                icon.style.transform = 'rotate(0deg)';
            }, 300);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const icon = document.getElementById('themeIcon');
            document.body.setAttribute('data-theme', savedTheme);
            icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            icon.style.transition = 'transform 0.3s ease';
        });

        // Date Filter
        let currentDateFilter = 'today';

        function applyDateFilter(filter) {
            currentDateFilter = filter;
            
            // Update active pill in all sections
            document.querySelectorAll('.filter-pill').forEach(pill => {
                if (pill.getAttribute('data-filter') === filter) {
                    pill.classList.add('active');
                } else {
                    pill.classList.remove('active');
                }
            });
            
            // Reload data with filter
            if (window.app && window.app.loadTransactions) {
                window.app.loadTransactions();
                window.app.updateDashboard();
            }
        }

        // Export filter function
        window.getCurrentDateFilter = function() {
            return currentDateFilter;
        };

        // Handle input focus - scroll into view
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.form-input, .form-textarea, .form-select');
            
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        const modal = this.closest('.modal');
                        if (modal) {
                            const modalBody = modal.querySelector('.modal-body');
                            const inputRect = this.getBoundingClientRect();
                            const modalRect = modalBody.getBoundingClientRect();
                            
                            if (inputRect.bottom > modalRect.bottom - 50) {
                                const scrollAmount = inputRect.bottom - modalRect.bottom + 100;
                                modalBody.scrollBy({
                                    top: scrollAmount,
                                    behavior: 'smooth'
                                });
                            }
                        }
                    }, 300);
                });
            });
        });

        // Swipe to delete functionality
        let touchStartX = 0;
        let touchEndX = 0;
        let currentSwipedItem = null;

        function handleSwipeStart(e, element) {
            touchStartX = e.touches[0].clientX;
            element.classList.add('swiping');
        }

        function handleSwipeMove(e, element) {
            touchEndX = e.touches[0].clientX;
            const diff = touchStartX - touchEndX;
            
            if (diff > 0 && diff < 100) {
                element.style.transform = `translateX(-${diff}px)`;
            }
        }

        function handleSwipeEnd(e, element, transactionId) {
            const diff = touchStartX - touchEndX;
            
            element.classList.remove('swiping');
            
            if (diff > 60) {
                // Swiped enough to reveal delete
                element.style.transform = 'translateX(-80px)';
                element.classList.add('swiped');
                currentSwipedItem = element;
                
                // Add click handler to delete button
                const deleteBtn = element.querySelector('.delete-action');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        confirmDelete(transactionId);
                    };
                }
            } else {
                // Reset
                element.style.transform = '';
                element.classList.remove('swiped');
            }
        }

        // Close swiped item when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (currentSwipedItem && !e.target.closest('.transaction-item')) {
                currentSwipedItem.style.transform = '';
                currentSwipedItem.classList.remove('swiped');
                currentSwipedItem = null;
            }
        });

        function confirmDelete(transactionId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) {
                const element = document.querySelector(`[data-transaction-id="${transactionId}"]`);
                if (element) {
                    element.classList.add('deleting');
                    setTimeout(() => {
                        if (window.app && window.app.deleteTransactionById) {
                            window.app.deleteTransactionById(transactionId);
                        }
                    }, 400);
                }
            } else {
                // Reset swipe
                if (currentSwipedItem) {
                    currentSwipedItem.style.transform = '';
                    currentSwipedItem.classList.remove('swiped');
                    currentSwipedItem = null;
                }
            }
        }

        // Export swipe handlers
        window.initSwipeHandlers = function(element, transactionId) {
            element.addEventListener('touchstart', (e) => handleSwipeStart(e, element));
            element.addEventListener('touchmove', (e) => handleSwipeMove(e, element));
            element.addEventListener('touchend', (e) => handleSwipeEnd(e, element, transactionId));
        };

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('transactionModal');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });

        // Prevent scroll when modal is open on iOS
        let scrollPosition = 0;

        window.closeModal = function() {
            const modal = document.getElementById('transactionModal');
            if (!modal.classList.contains('active')) return;
            
            modal.classList.add('closing');
            
            setTimeout(() => {
                modal.classList.remove('active', 'closing');
                document.body.classList.remove('modal-open');
                
                // Restore scroll
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('position');
                document.body.style.removeProperty('top');
                document.body.style.removeProperty('width');
                window.scrollTo(0, scrollPosition);
            }, 300);
            
            // Call app.js closeModal if exists
            if (window.app && window.app.closeModal) {
                window.app.currentTransaction = null;
            }
        };
    </script>
</body>
</html>
